<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Legal Documents</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Reuse hub styling -->
  <link rel="stylesheet" href="/ai-nominclactor/assets/css/style.css">
</head>
<body style="padding:24px;background:#0b1220;color:#e5e7eb;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif">

  <p>
    <a href="/" style="text-decoration:none;border:1px solid #374151;padding:8px 12px;border-radius:10px;background:#111827;color:#e5e7eb">
      ← Return to Hub
    </a>
  </p>

  <h1 style="margin:12px 0">Legal Documents</h1>
  <p style="max-width:720px;line-height:1.5">
    This module handles <strong>collection</strong> and <strong>storage</strong> of legal documents:
    biometric consent, releases of information, and other signed artifacts tied to VSC sessions.
    Access to downstream modules will be gated here.
  </p>

  <!-- MAIN GRID -->
  <section style="margin-top:24px;display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start;">

    <!-- LEFT: CONSENT / RELEASE CAPTURE FORM -->
    <div style="flex:1 1 320px;background:#020617;border-radius:12px;padding:16px;border:1px solid #1f2937;">
      <h2 style="margin-top:0;margin-bottom:8px;font-size:18px;">Consent / Release Capture</h2>
      <p style="margin:0 0 12px 0;font-size:14px;line-height:1.5;">
        Collect a new consent or release, tie it to this device/session, and push it into the repository.
      </p>

      <p id="consentStatus"
         style="margin:0 0 12px 0;font-size:13px;color:#9ca3af;">
        Status: awaiting consent
      </p>

      <form id="consentForm" style="display:flex;flex-direction:column;gap:8px;font-size:13px;">
        <label style="display:flex;flex-direction:column;gap:4px;">
          <span>Client Name</span>
          <input id="cfClientName"
                 type="text"
                 required
                 style="border-radius:6px;border:1px solid #374151;padding:6px 8px;background:#020617;color:#e5e7eb;">
        </label>

        <label style="display:flex;flex-direction:column;gap:4px;">
          <span>Date of Birth</span>
          <input id="cfClientDOB"
                 type="date"
                 required
                 style="border-radius:6px;border:1px solid #374151;padding:6px 8px;background:#020617;color:#e5e7eb;">
        </label>

        <label style="display:flex;flex-direction:column;gap:4px;">
          <span>Document Type</span>
          <select id="cfDocType"
                  required
                  style="border-radius:6px;border:1px solid #374151;padding:6px 8px;background:#020617;color:#e5e7eb;">
            <option value="">— Select type —</option>
            <option value="biometric-consent">Biometric + AI Consent</option>
            <option value="general-consent">General Treatment Consent</option>
            <option value="roi-single">Release of Information – Single Party</option>
            <option value="roi-multi">Release of Information – Multiple Parties</option>
            <option value="other-legal">Other Legal Document</option>
          </select>
        </label>

        <label style="display:flex;flex-direction:column;gap:4px;">
          <span>Scope / Parties</span>
          <textarea id="cfScope"
                    rows="3"
                    placeholder="Who can see what? List agencies, providers, or scope limits..."
                    style="border-radius:6px;border:1px solid #374151;padding:6px 8px;background:#020617;color:#e5e7eb;resize:vertical;"></textarea>
        </label>

        <label style="display:flex;flex-direction:column;gap:4px;">
          <span>Electronic Signature (type full legal name)</span>
          <input id="cfSignature"
                 type="text"
                 required
                 placeholder="Type full name to sign"
                 style="border-radius:6px;border:1px solid #374151;padding:6px 8px;background:#020617;color:#e5e7eb;">
        </label>

        <label style="display:flex;align-items:flex-start;gap:8px;margin-top:4px;">
          <input id="cfAcknowledge"
                 type="checkbox"
                 required
                 style="margin-top:2px;">
          <span>
            I confirm that I have read and understood the consent/release terms and that this electronic
            signature is legally binding in my jurisdiction (where permitted).
          </span>
        </label>

        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
          <button type="submit"
                  style="border:none;border-radius:8px;padding:8px 12px;background:#22c55e;color:#020617;font-weight:600;cursor:pointer;">
            Save Legal Document
          </button>

          <button type="button"
                  id="btnConsentIntake"
                  style="border:1px solid #4b5563;border-radius:8px;padding:8px 12px;background:#111827;color:#e5e7eb;font-weight:500;cursor:pointer;">
            Run Voice Gate Check
          </button>
        </div>
      </form>
    </div>

    <!-- RIGHT: DOCUMENTS ON FILE -->
    <div style="flex:1 1 260px;background:#020617;border-radius:12px;padding:16px;border:1px solid #1f2937;">
      <h2 style="margin-top:0;margin-bottom:8px;font-size:18px;">Documents on File</h2>
      <p style="margin:0 0 12px 0;font-size:14px;line-height:1.5;">
        Documents associated with this device/session are listed here. The repository listener can sync or
        export them downstream.
      </p>
      <ul id="docList" style="margin:0;padding-left:18px;font-size:13px;color:#9ca3af;">
        <li>No documents loaded yet.</li>
      </ul>
    </div>
  </section>

  <!-- SESSION GUARD / LEDGER -->
  <section style="margin-top:24px;background:#020617;border-radius:12px;padding:16px;border:1px solid #1f2937;">
    <h2 style="margin-top:0;margin-bottom:8px;font-size:18px;">Session Guard & Ledger</h2>
    <p style="margin:0 0 8px 0;font-size:14px;line-height:1.5;">
      This screen will become the primary gate:
      <strong>no access</strong> to Pre-Assessment, Psychosocial, Treatment Plan, or Group modules
      until consent is granted and biometric voice checks pass.
    </p>
    <pre id="ledgerLog"
         style="margin:0;margin-top:8px;font-size:12px;background:#020617;color:#9ca3af;white-space:pre-wrap;"></pre>
  </section>

  <script>
    (function () {
      var STORAGE_KEY = "vsc_legal_docs_v1";

      function log(msg, payload) {
        var el = document.getElementById('ledgerLog');
        if (!el) return;
        var line = "[" + new Date().toISOString() + "] " + msg;
        if (payload) {
          try {
            line += " " + JSON.stringify(payload);
          } catch (e) {}
        }
        el.textContent = (el.textContent ? el.textContent + "\n" : "") + line;
      }

      function updateConsentStatus(text) {
        var el = document.getElementById('consentStatus');
        if (el) el.textContent = "Status: " + text;
      }

      function loadDocs() {
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          var parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed;
        } catch (e) {
          log("Error loading stored legal docs", { error: String(e && e.message || e) });
          return [];
        }
      }

      function persistDocs(docs) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
        } catch (e) {
          log("Error persisting legal docs", { error: String(e && e.message || e) });
        }
      }

      function renderDocList(docs) {
        var list = document.getElementById('docList');
        if (!list) return;
        list.innerHTML = "";
        if (!docs.length) {
          var li = document.createElement("li");
          li.textContent = "No documents loaded yet.";
          list.appendChild(li);
          return;
        }
        docs.forEach(function (doc) {
          var li = document.createElement("li");
          var label = (doc.docTypeLabel || doc.docType || "Document") +
                      " — " + (doc.clientName || "Unknown") +
                      " — " + (doc.createdAt || doc.ts || "");
          li.textContent = label;
          list.appendChild(li);
        });
      }

      // Only talk to the new VoiceGate – no old Releases/Consents UI
      function ensureGate() {
        try {
          if (window.AIEngine && AIEngine.VoiceGate && typeof AIEngine.VoiceGate.require === "function") {
            AIEngine.VoiceGate.require({ source: "legal-docs", path: location.pathname });
            log("VoiceGate.require() invoked from legal-docs shell.");
          } else {
            log("VoiceGate not available on this page.");
          }
        } catch (err) {
          log("Voice gate error:", { error: String(err && err.message || err) });
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        log("LEGAL-DOCS shell loaded.");
        updateConsentStatus("checking voice gate…");
        ensureGate();

        var existing = loadDocs();
        renderDocList(existing);

        if (window.AI_BUS && typeof AI_BUS.subscribe === "function") {
          AI_BUS.subscribe("voicegate:granted", function (evt) {
            updateConsentStatus("voice consent granted");
            log("voicegate:granted received.", evt && evt.payload);
          });
          AI_BUS.subscribe("biometric:gate:granted", function (evt) {
            log("biometric:gate:granted observed in legal-docs.", evt && evt.payload);
          });
        }

        var btn = document.getElementById("btnConsentIntake");
        if (btn) {
          btn.addEventListener("click", function () {
            try {
              ensureGate();
              updateConsentStatus("voice gate active");
            } catch (e) {
              log("Consent button error:", { error: String(e && e.message || e) });
            }
          });
        }

        var form = document.getElementById("consentForm");
        if (form) {
          form.addEventListener("submit", function (evt) {
            evt.preventDefault();
            try {
              var nameEl = document.getElementById("cfClientName");
              var dobEl = document.getElementById("cfClientDOB");
              var typeEl = document.getElementById("cfDocType");
              var scopeEl = document.getElementById("cfScope");
              var sigEl = document.getElementById("cfSignature");
              var ackEl = document.getElementById("cfAcknowledge");

              var clientName = nameEl && nameEl.value.trim();
              var clientDOB  = dobEl && dobEl.value;
              var docType    = typeEl && typeEl.value;
              var scope      = scopeEl && scopeEl.value.trim();
              var signature  = sigEl && sigEl.value.trim();
              var acknowledged = !!(ackEl && ackEl.checked);

              if (!clientName || !clientDOB || !docType || !signature || !acknowledged) {
                alert("All required fields must be completed and acknowledgment must be checked.");
                return;
              }

              var typeLabel = (typeEl && typeEl.options && typeEl.selectedIndex >= 0)
                ? typeEl.options[typeEl.selectedIndex].textContent
                : docType;

              var doc = {
                id: "legal-" + Date.now(),
                clientName: clientName,
                clientDOB: clientDOB,
                docType: docType,
                docTypeLabel: typeLabel,
                scope: scope,
                signature: signature,
                acknowledged: acknowledged,
                path: location.pathname,
                module: "legal-docs",
                createdAt: new Date().toISOString()
              };

              var docs = loadDocs();
              docs.push(doc);
              persistDocs(docs);
              renderDocList(docs);

              updateConsentStatus("document captured");
              log("Legal document captured.", doc);

              if (window.AI_BUS && typeof AI_BUS.publish === "function") {
                AI_BUS.publish("legal:doc:capture", { payload: doc });
              }

              scopeEl.value = "";
            } catch (e) {
              log("Error capturing legal document", { error: String(e && e.message || e) });
              alert("Error capturing legal document. See console / ledger log.");
            }
          });
        }
      });
    })();
  </script>

  <!-- SHARED STACK -->
  <script src="/shared/ai/ai_bus.js?v=1759319983"></script>
  <script src="/shared/overrides/ai_action_dispatch.js"></script>
  <script src="/shared/vcall/vcall-bridge.js"></script>
  <script src="/group/ui/ai-button-observer.js"></script>
  <script src="/shared/ai/vsc_bridge.js?v=1759319983"></script>
  <script src="/shared/ai/interop_bridge_polyfill.js?v=1759319983"></script>

  <!-- NEW VOICE GATE ENGINE -->
  <script src="/shared/consent/biometric_voice_gate.js?v=1759319983"></script>

  <!-- Existing consent stack (now only for background / ledger behavior, not UI) -->
  <script src="/shared/consent/bio_consent.js?v=1759319983"></script>
  <script src="/shared/ai/biometric_ingest.js?v=1759319983"></script>
  <script src="/shared/ai/vnp_adapter.js?v=1759319983"></script>

  <script src="/ops/consent/bridge_bus.js?v=20251015-004808"></script>
  <script src="/ops/consent/collectors.js?v=20251015-004808"></script>
  <script src="/ops/consent/orchestrator.js?v=20251015-004808"></script>
  <script src="/ops/consent/perm_panel.js?v=20251015-004808"></script>

  <script src="/ops/repo_storage.js"></script>
  <script src="/shared/consent/inbox_boot.js"></script>
</body>
</html>

