(()=>{const pid="vsc-perm-panel";document.getElementById(pid)?.remove();const wrap=document.createElement("div");wrap.id=pid;Object.assign(wrap.style,{position:"fixed",bottom:"14px",right:"14px",padding:"10px",background:"#111",color:"#fff",font:"12px system-ui",borderRadius:"12px",boxShadow:"0 6px 18px rgba(0,0,0,.4)",zIndex:999999,width:"260px"});wrap.innerHTML=`<div style="font-weight:600;margin-bottom:6px;">Permissions</div><div style="display:flex;gap:6px;flex-wrap:wrap;"><button id="btnMic"style="flex:1 1 48%;padding:6px;border:0;border-radius:8px;background:#2e7d32;color:#fff">Mic</button><button id="btnCam"style="flex:1 1 48%;padding:6px;border:0;border-radius:8px;background:#2e7d32;color:#fff">Camera</button><button id="btnLoc"style="flex:1 1 48%;padding:6px;border:0;border-radius:8px;background:#1565c0;color:#fff">Location</button><button id="btnWeb"style="flex:1 1 48%;padding:6px;border:0;border-radius:8px;background:#6a1b9a;color:#fff">WebAuthn</button><button id="btnTier"style="flex:1 1 100%;padding:6px;border:0;border-radius:8px;background:#0b5;color:#fff;margin-top:4px">Run Tier-Required</button></div><div id="permNote"style="opacity:.75;margin-top:8px;line-height:1.35"></div>`;document.body.appendChild(wrap);const note=wrap.querySelector("#permNote");const setNote=t=>note.textContent=t;const save=(k,o)=>{const a=JSON.parse(localStorage.getItem(k)||"[]");a.push({...o,_saved:new Date().toISOString()});localStorage.setItem(k,JSON.stringify(a));};async function reqMic(){try{await navigator.mediaDevices.getUserMedia({audio:true});AIBridge?.emit?.({type:"consent.granted",payload:{scope:"mic"}});save("vsc:pre:consent",{scope:"mic",granted:true});return true;}catch(e){AIBridge?.emit?.({type:"consent.denied",payload:{scope:"mic"}});save("vsc:pre:consent",{scope:"mic",granted:false,err:String(e?.name||e)});return false;}}async function reqCam(){try{await navigator.mediaDevices.getUserMedia({video:true});AIBridge?.emit?.({type:"consent.granted",payload:{scope:"cam"}});save("vsc:pre:consent",{scope:"cam",granted:true});return true;}catch(e){AIBridge?.emit?.({type:"consent.denied",payload:{scope:"cam"}});save("vsc:pre:consent",{scope:"cam",granted:false,err:String(e?.name||e)});return false;}}async function reqLoc(){if(!("geolocation"in navigator)){AIBridge?.emit?.({type:"consent.unavailable",payload:{scope:"location"}});save("vsc:pre:consent",{scope:"location",available:false});return false;}return new Promise(res=>{navigator.geolocation.getCurrentPosition(pos=>{AIBridge?.emit?.({type:"consent.granted",payload:{scope:"location",coords:pos.coords}});save("vsc:pre:consent",{scope:"location",granted:true,coords:pos.coords});res(true);},err=>{AIBridge?.emit?.({type:"consent.denied",payload:{scope:"location"}});save("vsc:pre:consent",{scope:"location",granted:false,err:String(err?.code||err)});res(false);});});}async function reqWeb(){if(!window.PublicKeyCredential){AIBridge?.emit?.({type:"consent.unavailable",payload:{scope:"webauthn"}});save("vsc:pre:consent",{scope:"webauthn",available:false});return false;}AIBridge?.emit?.({type:"consent.granted",payload:{scope:"webauthn"}});save("vsc:pre:consent",{scope:"webauthn",granted:true});return true;}async function runTier(){const required=["ppi-basic","mic","cam"];AIBridge?.emit?.({type:"consent.granted",payload:{scope:"ppi-basic"}});save("vsc:pre:consent",{scope:"ppi-basic",granted:true});await reqMic();await reqCam();}wrap.querySelector("#btnMic").onclick=async()=>{setNote("Requesting microphone…");await reqMic();setNote("Done.");};wrap.querySelector("#btnCam").onclick=async()=>{setNote("Requesting camera…");await reqCam();setNote("Done.");};wrap.querySelector("#btnLoc").onclick=async()=>{setNote("Requesting location…");await reqLoc();setNote("Done.");};wrap.querySelector("#btnWeb").onclick=async()=>{setNote("Logging WebAuthn consent…");await reqWeb();setNote("Done.");};wrap.querySelector("#btnTier").onclick=async()=>{setNote("Running tier-required consents…");await runTier();setNote("Done.");};function hud(){const id="vsc-hud";document.getElementById(id)?.remove();const d=document.createElement("div");d.id=id;Object.assign(d.style,{position:"fixed",top:"10px",left:"10px",padding:"6px 10px",background:"#0b5",color:"#fff",font:"12px system-ui",borderRadius:"10px",zIndex:99998});const n=k=>(JSON.parse(localStorage.getItem(k)||"[]")||[]).length;d.textContent=`✅ Intake • seeds:${n("vsc:pre:seed")} consents:${n("vsc:pre:consent")} ai:${n("vsc:ai:results")}`;document.body.appendChild(d);}hud();window.addEventListener("storage",()=>{try{hud();}catch{}});console.log("[perm-panel] mounted");})();
